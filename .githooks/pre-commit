#!/bin/bash

# PayBack Pre-Commit Hook
# Runs unit tests and checks for secrets before allowing commit
# To install: git config core.hooksPath .githooks

set -e

echo "üîí Checking for secrets in staged files..."
echo ""

# Check for accidentally staged secret files
STAGED_FILES=$(git diff --cached --name-only 2>/dev/null || true)

# List of patterns that should never be committed
SECRET_PATTERNS=(
    ".env.local"
    ".env"
    "*.p12"
    "*.mobileprovision"
)

for pattern in "${SECRET_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | grep -q "$pattern"; then
        echo "‚ùå ERROR: Attempted to commit secret file: $pattern"
        echo ""
        echo "This file contains sensitive data and should not be committed."
        echo "Remove it from staging with: git reset HEAD <file>"
        echo ""
        exit 1
    fi
done

echo "‚úÖ No secrets detected in staged files."
echo ""

echo "üß™ Running unit tests before commit..."
echo ""

# Check if xcodebuild is available
if ! command -v xcodebuild &> /dev/null; then
    echo "‚ùå xcodebuild not found. Skipping tests."
    exit 0
fi

# Run unit tests
if xcodebuild test \
    -project PayBack.xcodeproj \
    -scheme PayBackTests \
    -configuration Debug \
    -destination 'platform=iOS Simulator,OS=latest,name=iPhone 15 Pro' \
    -quiet \
    2>&1 | grep -E "(Test Suite|FAILED|PASSED)"; then
    
    echo ""
    echo "‚úÖ All tests passed! Proceeding with commit."
    exit 0
else
    echo ""
    echo "‚ùå Tests failed! Commit aborted."
    echo ""
    echo "To skip this check (not recommended), use:"
    echo "  git commit --no-verify"
    exit 1
fi
