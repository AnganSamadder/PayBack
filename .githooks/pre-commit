#!/bin/bash

# PayBack Pre-Commit Hook
# Runs unit tests and checks for secrets before allowing commit
# To install: git config core.hooksPath .githooks

set -e

echo "üîí Checking for secrets in staged files..."
echo ""

# Check for accidentally staged secret files
STAGED_FILES=$(git diff --cached --name-only 2>/dev/null || true)

# List of patterns that should never be committed
SECRET_PATTERNS=(
    ".env.local"
    ".env"
    "*.p12"
    "*.mobileprovision"
)

for pattern in "${SECRET_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | grep -q "$pattern"; then
        echo "‚ùå ERROR: Attempted to commit secret file: $pattern"
        echo ""
        echo "This file contains sensitive data and should not be committed."
        echo "Remove it from staging with: git reset HEAD <file>"
        echo ""
        exit 1
    fi
done

# Check newly added lines in staged diff for high-risk secret patterns.
# Exclude test files where mock JWTs / tokens are expected.
STAGED_ADDED_LINES=$(git diff --cached --no-color --unified=0 -- ':!*Tests*' ':!*tests*' ':!*Fixtures*' | grep '^+' | grep -v '^+++' || true)
CONTENT_SECRET_PATTERNS=(
    "eyJ[A-Za-z0-9_-]{8,}\\.[A-Za-z0-9_-]{8,}\\.[A-Za-z0-9_-]{8,}"   # JWT-like token
    "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"                # Private key material
    "sk_live_[A-Za-z0-9]{16,}"                                       # Stripe live key
    "xox[baprs]-[A-Za-z0-9-]{10,}"                                   # Slack token
)

for pattern in "${CONTENT_SECRET_PATTERNS[@]}"; do
    if echo "$STAGED_ADDED_LINES" | grep -Eq "$pattern"; then
        echo "‚ùå ERROR: Potential secret detected in staged content (pattern: $pattern)"
        echo ""
        echo "Remove sensitive values from staged changes before committing."
        echo ""
        exit 1
    fi
done

echo "‚úÖ No secrets detected in staged files."
echo ""

echo "üß™ Running unit tests before commit..."
echo ""

# Check if xcodebuild is available
if ! command -v xcodebuild &> /dev/null; then
    echo "‚ùå xcodebuild not found. Skipping tests."
    exit 0
fi

# Run unit tests
if xcodebuild test \
    -project PayBack.xcodeproj \
    -scheme PayBackTests \
    -configuration Debug \
    -destination 'platform=iOS Simulator,OS=latest,name=iPhone 15 Pro' \
    -quiet \
    2>&1 | grep -E "(Test Suite|FAILED|PASSED)"; then
    
    echo ""
    echo "‚úÖ All tests passed! Proceeding with commit."
    exit 0
else
    echo ""
    echo "‚ùå Tests failed! Commit aborted."
    echo ""
    echo "To skip this check (not recommended), use:"
    echo "  git commit --no-verify"
    exit 1
fi
