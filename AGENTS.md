# PROJECT KNOWLEDGE BASE

**This is a LIVING DOCUMENT. Agents: Update this file after solving hard or recurring issues. Do not treat as a changelog.**

## OVERVIEW

PayBack is an expense sharing app featuring a native Swift iOS client (MVVM + Central Store) and a Convex backend (TypeScript), with a web landing page.

## STRUCTURE

```
.
├── apps/web/          # Vite + React landing page
├── apps/backend/      # Convex backend (schema, functions, auth)
├── apps/ios/PayBack/  # Native iOS application
├── apps/android/      # Android scaffold (placeholder)
├── packages/          # Shared config packages (eslint, prettier, typescript, design-tokens)
└── scripts/           # CI/CD utilities
```

## WHERE TO LOOK

| Task           | Location                                  | Notes                              |
| -------------- | ----------------------------------------- | ---------------------------------- |
| iOS UI/Views   | `apps/ios/PayBack/Sources/Features`       | Organized by domain                |
| iOS State      | `apps/ios/PayBack/Sources/Services/State` | `AppStore.swift` is the God Object |
| Backend Schema | `apps/backend/convex/schema.ts`           | Source of truth for data model     |
| Backend Logic  | `apps/backend/convex/`                    | Mutations, queries, actions        |
| Backend Tests  | `apps/backend/convex/tests/`              | Integration focused                |
| iOS Tests      | `apps/ios/PayBack/Tests`                  | Unit + integration                 |
| Web App        | `apps/web/src/`                           | Vite + React + TanStack Router     |
| Design System  | `apps/ios/PayBack/Sources/DesignSystem`   | iOS components                     |

## COMMANDS

```bash
# Monorepo Development
bun run dev            # Start web + convex backend together
bun run dev:web        # Web only (Vite)
bun run dev:backend    # Convex backend only

# Quality Checks
bun run lint           # ESLint across all workspaces
bun run lint:fix       # ESLint with --fix
bun run format         # Prettier --write
bun run format:check   # Prettier --check (CI mode)
bun run typecheck      # TypeScript check

# Testing
bun run test           # Vitest across workspaces
bun run ci             # Full local CI pipeline

# iOS (Full CI Simulation)
./scripts/test-ci-locally.sh

# iOS Build (manual)
xcodebuild -scheme PayBack -destination "platform=iOS Simulator,name=iPhone 15"
```

## LOCAL SANITIZER TESTING

Run sanitizers locally before pushing to catch thread-safety and memory bugs early. CI only runs sanitizers on merges to `main`, so local runs are the first line of defense.

```bash
# Thread Sanitizer (catches data races)
SANITIZER=thread ./scripts/test-ci-locally.sh

# Address Sanitizer (catches memory errors: use-after-free, buffer overflow)
SANITIZER=address ./scripts/test-ci-locally.sh

# Standard run with coverage (what PRs run)
./scripts/test-ci-locally.sh
```

**When to sanitize:**

- Always run `SANITIZER=thread` before pushing changes to concurrency code (`async/await`, actors, `@State`, `@Published`)
- Always run `SANITIZER=address` before pushing changes to data structures, collections, or any manual memory management
- Run both before any PR that touches `AppStore`, `Services/`, or `Concurrency/` code

## CONVENTIONS

- **Commits**: Conventional Commits (`feat:`, `fix:`). Single line.
- **Linting**: Zero warnings policy (`FAIL_ON_WARNINGS=1`).
- **Runtime**: `bun` / `bunx` preferred over `npm`.
- **Monorepo**: Turborepo for task orchestration, Bun workspaces for dependency management.
- **Comments**: Minimalist approach. Only explain _why_ something is done if it's not obvious from the code. Avoid "what" comments (e.g., "// Loop through items").
- **iOS Project**: **NEVER edit the Xcode project directly.** Always modify `project.yml` and regenerate.

## XcodeGen Project Management

The iOS project is generated by XcodeGen. **Never edit `project.pbxproj` or use Xcode's Build Settings UI.**

### Rule

All project configuration changes must be made in `project.yml`. After editing, regenerate:

```bash
xcodegen generate
```

### Build Number Rule

**Always bump `CURRENT_PROJECT_VERSION` in `project.yml`, then run `xcodegen generate`.** Never edit the Xcode project directly.

```yaml
# project.yml → settings.base
CURRENT_PROJECT_VERSION: 95   # increment by 1 each release
```

```bash
xcodegen generate
```

### Common Examples

| What you want to change      | Where in `project.yml`                    | Example                                  |
| ---------------------------- | ----------------------------------------- | ---------------------------------------- |
| Build number                 | `settings.base.CURRENT_PROJECT_VERSION`   | `95`                                     |
| App version                  | `settings.base.MARKETING_VERSION`         | `1.2.0`                                  |
| Build setting (project-wide) | `settings.base`                           | `SWIFT_VERSION: "5.10"`                  |
| Build setting (per-config)   | `settings.configs.Debug`                  | `GCC_OPTIMIZATION_LEVEL: 0`              |
| Build setting (per-target)   | `targets.PayBack.settings.base`           | `PRODUCT_BUNDLE_IDENTIFIER`              |
| Info.plist key               | `targets.PayBack.info.properties`         | `ITSAppUsesNonExemptEncryption: false`   |
| Add SPM dependency           | `packages` section                        | `url: https://github.com/...`            |
| New build configuration      | `configs` section                         | `Internal: release`                      |
| Scheme settings              | `schemes.PayBack`                         | `archive.config: Release`                |
| Entitlements                 | `targets.PayBack.entitlements.properties` | `com.apple.developer.associated-domains` |

### Why This Matters

- `project.pbxproj` is auto-generated and will be overwritten
- Changes made in Xcode UI will be lost on regeneration
- `project.yml` is the source of truth and enables code review of project config

## NOTES

- **CI Parity**: `test-ci-locally.sh` mirrors GitHub Actions for iOS.
- **Architecture**: iOS uses a Central Store; avoid local `@State` for shared data.
- **Backend**: `accounts` table is the user source of truth; handle ghost data via `bulkImport`.
- **Backend location**: Convex functions live in `apps/backend/convex/` (configured by root `convex.json`).

## Monorepo Tooling

- Package manager is Bun (`bun`, `bunx`), with Turbo for task orchestration.
- Workspace checks are run from root with `bun run ci`.
- Workspaces are under `apps/*` and `packages/*`.

## Primary CI Parity Rule

- Always use the local CI simulation script for full iOS test runs: `./scripts/test-ci-locally.sh`.
- This script must remain in lockstep with GitHub Actions. If `.github/workflows/ci.yml` changes, update `scripts/test-ci-locally.sh` to replicate CI behavior exactly (steps, flags, simulator selection, coverage settings).
- If you change CI steps in `.github/workflows/ci.yml`, update `./scripts/test-ci-locally.sh` to match.

## Zero Warnings Policy

- Test runs must be warning-free (treat warnings as failures).
- Before pushing, run: `FAIL_ON_WARNINGS=1 ./scripts/test-ci-locally.sh`.
- If Xcode emits non-actionable tool warnings, update `./scripts/test-ci-locally.sh` warning filtering rather than ignoring warnings in code.

## Simulator Selection

- CI dynamically chooses the newest iOS runtime with preferred iPhone models.
- For local parity, use the same logic by running `./scripts/test-ci-locally.sh`.
- If running manually, use `xcrun simctl list devices iPhone available` and pick a matching UDID.

## Coverage

- CI expects coverage when sanitizer is `none`.
- Coverage output is stored in `coverage.json` and `coverage-report.txt`.
- Coverage threshold in CI is `48.0%`.

## Swift Code Style

### Imports

- Keep imports minimal and file-scoped.
- Prefer standard ordering: Apple frameworks, third-party, internal modules.
- Avoid unused imports.

### Formatting

- Follow existing indentation (spaces, 4-space standard in Swift files).
- Prefer trailing closures when it improves readability.
- Align chained modifiers vertically in SwiftUI.

### Types and Naming

- Types use `UpperCamelCase`, functions/variables use `lowerCamelCase`.
- Boolean names should read clearly (`isValid`, `hasAccount`, `shouldSync`).

### SwiftUI

- Keep views small and composable.
- Prefer private computed subviews for complex layouts.
- Use `@State`, `@StateObject`, and `@EnvironmentObject` consistently with existing patterns.

### Error Handling

- Prefer typed errors (enums conforming to `Error`) over string-based errors.
- Keep user-facing error messages sanitized (no PII).

### Concurrency

- Respect actor isolation in existing services.
- Use `async`/`await` rather than completion callbacks in new code.

## DELETION PROTOCOL

### Hard Delete (Admin/Backend)

When a user is **hard deleted** from the Convex dashboard or via `performHardDelete`:

1. The user's `accounts` record is permanently deleted
2. All `account_friends` records owned by the user are deleted
3. **Cascading cleanup**: Friends of the deleted user have their links removed via:
   - `by_linked_account_id` index
   - `by_linked_account_email` index
   - `by_linked_member_id` index (added 2026-02-07)
4. The deleted user disappears from all friend lists immediately (Convex live sync)

### Soft Delete (User-Initiated)

When a user **deletes their own account**:

1. The account is marked as deleted (soft delete flag)
2. The user becomes a "Ghost" - their data remains for history purposes
3. Friends see the user as **unlinked** but can still see past transactions
4. Name displays as the friend's nickname or original name (not "Unknown")

### Key Tables

- `accounts`: User source of truth
- `account_friends`: Friend relationships with optional linking to accounts
- Indexes: `by_linked_account_id`, `by_linked_account_email`, `by_linked_member_id`

## MEMBER ID RESOLUTION (iOS)

### The Problem

After CSV import, group members may have different `id` values than their corresponding friends' `memberId`. This breaks `isFriend` checks.

### The Solution

`GroupMember` has an `accountFriendMemberId: UUID?` property that stores the original friend's `memberId`. When looking up if a group member is a friend:

```swift
// FriendDetailView.swift - isFriend computed property
let lookupId = friend.accountFriendMemberId ?? friend.id
return store.friends.contains { $0.memberId == lookupId }
```

### Import ID Consistency

`DataImportService.swift` ensures:

1. `memberIdMapping` is checked before generating new UUIDs
2. `nameToExistingId` provides name-based deduplication
3. Same person = same UUID across friends and group members

## CSV IMPORT LOGIC (iOS <-> Convex)

### The Remapping Mismatch (Fixed 2026-02-07)

**Problem**: iOS imports generate **new local UUIDs** to avoid collisions, but `performBulkImport` originally sent the **original CSV UUIDs** to Convex.
**Result**: iOS stores Group `ABC` (remapped), Convex stores Group `XYZ` (original). Syncing breaks because iOS doesn't know `XYZ`.

### The Protocol

1. **Local Import**: `importData` generates `memberIdMapping` and `groupIdMapping` (Original -> New).
2. **Transform**: `applyRemappings()` mutates the parsed data using these mappings.
3. **Bulk Import**: Sends the **remapped UUIDs** to Convex.
4. **Consistency**: Local iOS state and Convex backend now share the exact same UUIDs.

**Rule**: Always pass `memberIdMapping` and `groupIdMapping` to `performBulkImport` to ensure ID consistency.

## BALANCE CALCULATION LOGIC (iOS)

### The Zero Balance Bug (Fixed 2026-02-07)

**Problem**: Users saw "Settled ($0.00)" even with unsettled transactions because `netBalance` calculations only checked the primary `friend.id` or `currentUser.id`. Linked accounts (via invites or CSV remapping) often have different IDs in the expense splits.

### The Fix

1. **Friend Detail**: `FriendDetailView.netBalance` must check BOTH `friend.id` AND `friend.accountFriendMemberId`.
2. **Dashboard**: `AppStore.netBalance(for: Group)` must use `currentUser.equivalentMemberIds` (from `UserAccount`) to catch all splits belonging to the user, including those under remapped IDs.

**Rule**: When calculating balances or filtering expenses, ALWAYS check for ID equivalence (`accountFriendMemberId` for friends, `equivalentMemberIds` for current user).

## USER LINKING PROCESS

### Overview

Linking connects a local "Unlinked" friend (often created manually or via CSV import) to a real registered User Account. This allows two users to share the same friend/member identity in groups and expenses.

### The Flow

1.  **Invite Creation**: User A creates a link for a specific group member (e.g., "Test User" with ID `X`).
2.  **Claiming**: User B ("Test User") clicks the link.
    - Backend (`inviteTokens:claim`) verifies the token.
    - It updates User B's `alias_member_ids` to include `X`. This is CRITICAL for User B to see expenses assigned to `X` as their own.
    - It updates User A's `account_friends` record for `X` to set `linked_account_id` to User B's account ID.
3.  **Syncing**:
    - User B receives updated `UserAccount` containing `alias_member_ids`.
    - User A receives updated `account_friends` list.

### ID Resolution Logic (The "0 Balance" Fix)

**Problem**: Before linking, User B is participating in expenses as ID `X`. After linking, User B logs in with ID `Y`.
**Solution**:

- Backend sends `alias_member_ids` (including `X`) in the User object.
- iOS `UserAccount` model MUST map `alias_member_ids` (JSON key) to `equivalentMemberIds` (Swift property) via `CodingKeys`.
- `AppStore` checks `equivalentMemberIds` when calculating "My" balance. `isMe(memberId)` checks `currentUser.id` OR `linkedMemberId` OR `equivalentMemberIds`.

### Friend Identity Resolution & Deduplication (Fixed 2026-02-07)

**Symptom**: User A sees two entries for "Test User" - one unlinked (original) and one linked (new account).
**Root Cause**: When a friend link is claimed, the backend might return both the original friend record and the new linked friend record if they exist separately in `account_friends` or `groups`.

**The Solution**:

1.  **Backend Enrichment**: `friends.ts` now includes `alias_member_ids` in the `AccountFriend` object (fetched from the linked user's account).
2.  **Client-Side Identity Map**:
    - `AppStore` builds a `memberAliasMap` during friend updates.
    - If Friend B lists Friend A's ID in its `aliasMemberIds`, Friend B is considered the "Master" and Friend A is the "Alias".
3.  **Deduplication**:
    - `AppStore.processFriendsUpdate` filters out any friend that is found to be an alias of another present friend.
    - Only the "Master" (linked) friend remains in the `store.friends` list.
4.  **Identity Checks**:
    - `store.areSamePerson(id1, id2)` checks the `memberAliasMap` to resolve identity, ensuring expenses assigned to the alias ID are correctly attributed to the master friend in the UI.

### Duplicate Friend Reappearance Guard (Fixed 2026-02-10)

**Symptom**: After account switch/login, owner still sees duplicate friend cards (linked + unlinked) for the same person.

**Root Causes**:

1. `scheduleFriendSync` previously synced a **pre-dedupe** friend list back to Convex, which could reintroduce duplicate rows.
2. DTO mapping could miss identity equivalence when `alias_member_ids` was sparse in some updates.

**Required Guards**:

1. In `AppStore.scheduleFriendSync`, only sync `self.friends` **after** `processFriendsUpdate(...)` dedupe.
2. In Convex friend DTO mapping, treat `linked_member_id` as an identity alias fallback (not only `alias_member_ids`).
3. In `friendMembers`, dedupe by `areSamePerson(...)` identity equivalence, not raw UUID equality.

**Rule**: Never write pre-dedupe friend arrays to cloud. Any friend identity check in UI lists must use equivalence (`areSamePerson`), not strict UUID match.

### Direct Expense Friend Drift Guard (Fixed 2026-02-11)

**Symptoms**:

- Direct expense creation fails with: `Member <name> is not a confirmed friend`.
- Direct expense appears for creator but not counterparty due missing `participant_emails`.

**Root Causes**:

1. Legacy friend/member-id drift: direct-group member ID can diverge from `account_friends.member_id` after remaps/link transitions.
2. Stale client friend sync can accidentally overwrite linked friend rows (`has_linked_account=false`) and strip link metadata.
3. Client may omit participant link metadata; backend previously relied too heavily on client-provided `linked_account_email`.

**Required Guards**:

1. In `expenses.ts`, resolve participant accounts server-side (email/id/member_id) and populate `participant_emails` from resolved accounts, not only client payload.
2. In direct-expense friend validation, keep identity-based match first, then allow a tight legacy fallback by unique normalized friend name when IDs have drifted.
3. In `friends.ts upsert`, preserve existing linked metadata/status when stale payloads attempt to downgrade a linked friend row.

**Rule**: Treat linked friend metadata as server-owned state. Client sync must never silently unlink a friend, and direct-expense visibility must be derivable server-side.

### Key Data Structures

- **UserAccount**: `equivalentMemberIds` stores all alias UUIDs (e.g., from invites/imports).
- **GroupMember**: `accountFriendMemberId` stores the UUID of the linked `AccountFriend` (if any).
- **AccountFriend**: Represents a direct friendship. Linked via `linkedAccountId` (String).

## LINKING RUNBOOK (READ FIRST)

For end-to-end linking/identity debugging and implementation rules, use:

- `docs/linking/ACCOUNT_LINKING_PIPELINE_RUNBOOK.md`

This runbook is the canonical operational guide for:

- invite claim + link-request acceptance pipeline
- canonical/alias invariants
- iOS selector correctness
- bulk import identity rules
- troubleshooting commands and test gates

## RELEASE BLOCKERS FIXED (2026-02-11)

### Convex Authorization Rule (Critical)

Never trust client-supplied `accountEmail` (or any ownership identifier) for destructive/identity mutations.

**Required pattern**:

1. Derive caller identity from auth (`getCurrentUser` / `getCurrentUserOrThrow`).
2. Resolve account email/id server-side from auth context.
3. Treat client `accountEmail` as optional legacy input at most, and reject mismatches where needed.

Applied to:

- `aliases:mergeMemberIds`
- `aliases:mergeUnlinkedFriends`
- `cleanup:deleteLinkedFriend`
- `cleanup:deleteUnlinkedFriend`
- `cleanup:selfDeleteAccount`

### Admin Mutation Guard

`admin:hardDeleteUser` must be admin-only. Use explicit admin allowlist checks from auth identity before deleting by email.

### Friend Linking Identity Type Rule

`account_friends.linked_account_id` must store auth/account `id` (string identity), not Convex document `_id`.
Using `_id` breaks comparisons/dedup paths that check against auth IDs.

### iOS Payload Compatibility Rule

When backend arg contracts change, keep iOS mutation payload keys aligned.

Current required keys:

- `aliases:mergeMemberIds`: `sourceId`, `targetCanonicalId`
- `cleanup:deleteLinkedFriend`: `friendMemberId`
- `cleanup:deleteUnlinkedFriend`: `friendMemberId`
- `aliases:mergeUnlinkedFriends`: no `accountEmail` from client

### iOS Realtime Sync Guard (Test/Startup Stability)

`AppStore.subscribeToSyncManager` must ignore realtime payloads until a session exists.
Otherwise empty remote snapshots can clobber local state before auth and break persistence expectations.

### Dependencies Thread-Safety Guard

`Dependencies.reset()` is called concurrently in tests; serialize it with a lock to avoid crashes in `DependenciesTests.testConcurrentReset_DoesNotCrash`.

### Add Expense Payer Identity Guard (iOS)

Do not infer `"Me"` from `group.members.first`.

Required behavior in `AddExpenseView`:

1. Default payer to the actual current-user member (`isCurrentUser` marker first, then `store.isCurrentUser(...)` fallback).
2. Render `"Me"` label using current-user identity, not array position.
3. Keep direct-group payer toggles working with the resolved identity.

If this rule is broken, users can save expenses with the wrong `paidByMemberId` while UI still shows `"Me"`.

### Direct Expense Friend Validation Guard (Convex)

In `expenses.create` for `group.is_direct`, friend matching must consider identity equivalence across:

- `account_friends.member_id`
- `account_friends.linked_member_id`
- alias closure from `member_aliases`

`member_id`-only matching causes false `"not a confirmed friend"` errors for valid linked friends with legacy IDs.

Additionally, if a friend has `linked_account_email` / `linked_account_id`, resolve the linked account and include:

- linked account `member_id`
- linked account `alias_member_ids`

Without linked-account alias expansion, direct expenses can still be rejected when group members use legacy alias IDs.

### Group Membership vs Friendship Rule (iOS)

Group membership does **not** imply direct friendship.

Required behavior:

1. `AppStore.loadRemoteData` must process only server-returned friends (`remoteFriends`) and must not synthesize friends from group members.
2. `AppStore.scheduleFriendSync` must sync only deduped `self.friends` and never `derivedFriendsFromGroups()`.

If this rule is broken, users can appear as unintended friends after shared group updates (e.g., friend-of-friend in a group).

### Expense Participant Identity Metadata Rule (iOS)

When upserting expenses to Convex, participant metadata must include correct linked account identity for **both**:

- current user identity aliases
- linked friends resolved via `areSamePerson(...)`

Required behavior:

1. Build participant `linkedAccountId` / `linkedAccountEmail` from resolved identity metadata (not only direct `currentUser.id` equality).
2. Normalize empty values to `nil` and lowercase emails before sending.

Missing participant linked-account metadata can prevent cross-account fan-out and cause expenses to appear missing after account switch.

### Clear-All Semantics (iOS <-> Convex)

`clearAllUserData` is expected to remove user-owned data **and** detach the user from shared visibility.

Required backend behavior:

1. `groups:clearAllForUser` must:
   - delete owned groups
   - remove the current user's canonical/alias member IDs from shared groups (leave group)
2. `expenses:clearAllForUser` must:
   - reconcile + delete owned expenses (`reconcileUserExpenses(..., [])` before delete)
   - delete `user_expenses` rows for the current user (shared expense visibility cleanup)

If this is not enforced, users can clear data and still see leftover shared groups/people or stale expense visibility.

### Friend UI Boundary Rule

Group participants are not equivalent to direct friends.

Required behavior:

1. Friends tab should render only true `AccountFriend` entries (confirmed friend list).
2. Group-derived people (`friendMembers`) can be used for identity resolution and group workflows, but not as canonical friend list UI.

If this boundary blurs, friend-of-friend participants (e.g., Bob in a shared group) appear as unintended friends.

## SECURITY HARDENING (2026-02-20)

### Group Upsert Authorization Rule (Convex)

`groups:create` may accept client-provided `id` for idempotent upserts.  
When that `id` already exists, backend must enforce owner authorization before patching.

**Rule**: Existing group updates by client ID are owner-only; never patch an existing group without verifying ownership.

### Group Delete Cascade Rule (Convex)

Deleting a group must also clean dependent expenses and fan-out visibility rows.

**Rule**: All group deletions (`deleteGroup`, `deleteGroups`, clear/leave flows when removing whole group) must:

1. Reconcile each group expense via `reconcileUserExpenses(..., [])`
2. Delete those expenses
3. Delete the group

### Member ID Reassignment Rule (Convex)

Canonical `accounts.member_id` is identity-critical and cannot be user-reassigned.

**Rule**: `users:updateLinkedMemberId` must reject canonical changes for accounts that already have `member_id`.  
Only legacy bootstrap for missing `member_id` is allowed, and even then only with unused IDs.

### Linked Account Resolution Privacy Rule (Convex)

`users:resolveLinkedAccountsForMemberIds` must not act as a global directory lookup.

**Rule**: Return linked account metadata only for member IDs within caller-visible identity surface (self aliases, owned/shared groups, direct friends and linked friend identities).

### Operational Function Exposure Rule (Convex)

Backfills/repairs are privileged operations.

**Rule**: migration and one-off repair endpoints must be `internalMutation` (or admin-gated) and never publicly callable by normal authenticated users.

### Authenticated Name-Fallback Rule (iOS)

Name-equality fallback can hide real same-name users.

**Rule**: In signed-in sessions, self-friend detection must be ID/link based only; use name fallback only in no-session/local contexts.

## CONVEX ENV ROUTING (iOS BUILD PIPELINE)

### Goal

Automatically route iOS builds to the correct Convex deployment without manual toggles:

- local dev + internal testing builds -> development Convex DB
- external TestFlight + App Store builds -> production Convex DB

### Required Configuration

1. `project.yml` defines three build configurations:
   - `Debug`
   - `Internal`
   - `Release`
2. `PayBack` target sets:
   - `PAYBACK_CONVEX_ENV=development` for `Debug` and `Internal`
   - `PAYBACK_CONVEX_ENV=production` for `Release`
3. `Info.plist` includes `PAYBACK_CONVEX_ENV=$(PAYBACK_CONVEX_ENV)`.
4. Runtime (`AppConfig.environment`) reads `PAYBACK_CONVEX_ENV` from bundle and falls back to debug/release only if missing/invalid.

### Scheme Contract

- `PayBackInternal` scheme archives with `Internal` config (development DB).
- `PayBack` scheme archives with `Release` config (production DB).

### Xcode Cloud Rule

Use separate workflows:

1. Internal testing workflow -> scheme `PayBackInternal`
2. External TestFlight / App Store workflow -> scheme `PayBack`

**Rule**: Never change Convex URLs manually for release cycles; choose the correct scheme/workflow and environment routing is automatic.

### CI Compile Guard for Convex Types (iOS)

`PAYBACK_CI_NO_CONVEX` can compile out concrete Convex service types (e.g., `ConvexAccountService`).

Required behavior:

1. `AppStore` and other core state/services must call `AccountService` protocol APIs directly.
2. Do not use unconditional casts/references to concrete Convex classes unless wrapped in `#if !PAYBACK_CI_NO_CONVEX`.

If violated, Xcode Cloud can fail with compile errors like `Cannot find type 'ConvexAccountService' in scope`.

## AUTH UX CONTINUITY (IOS)

### Auth Draft Persistence Rule

Login, signup, and verification are a single flow and must share form draft state.

**Required behavior:**

1. Keep auth inputs in `AuthCoordinator` (`@Published`), not per-view local `@State`, so route changes do not wipe fields.
2. Navigating Login -> Signup pre-fills signup email from login input.
3. Navigating Signup -> Login should carry edited signup email back to login.
4. Navigating Verification -> back should return to Signup with the existing signup draft intact.

### Native Text Input Metadata Rule

Use Apple-native content types so AutoFill and strong-password suggestions work reliably.

**Required behavior:**

1. Login email uses `.textContentType(.username)` and no autocapitalization/correction.
2. Login password uses `.textContentType(.password)`.
3. Signup password uses `.textContentType(.newPassword)`.
4. Signup confirm password uses `.textContentType(.password)` and submit label `.join` to finish the flow cleanly.
5. Verification code input uses `.textContentType(.oneTimeCode)` and keeps a keyboard dismiss affordance.

## ADD EXPENSE UX CONTINUITY (IOS) (2026-02-20)

### Save Validation Parity Rule

Add Expense top-bar save/check availability must match actual save guards.

**Required behavior:**

1. Use one shared validation path for both button disabled state and `save()` guard.
2. Validation must include: non-empty description, positive amount, at least one participant, and non-empty computed splits.
3. Never allow silent no-op on save tap due to guard mismatch.

### Save Validation Feedback Rule

When save is blocked, users must see exactly what is missing.

**Required behavior:**

1. `saveValidationMessage` should return explicit missing-field guidance, and include multiple missing items in one message when applicable.
2. Do not trigger warning/success-style haptics on blocked-save validation paths; show alert copy only.

### Split Summary Label Rule

Split label text must reflect participant selection state, not just split mode.

**Required behavior:**

1. If exactly one participant is selected, use `Only me` or `Only <name>` (never “Split equally”).
2. For multi-participant splits, use mode-based labels (`Split equally`, `Split by percent`, etc.).
3. If only a subset of group members is selected, append count context like `(<n> people)`.

### Split Sheet Exit Affordance Rule

Swipe-to-dismiss is not sufficient as the only close interaction in split configuration.

**Required behavior:**

1. Split detail sheet must expose an explicit top-bar confirmation control (checkmark) that dismisses the sheet.

### Add Expense Swipe Gesture Rule

Swipe gestures on Add Expense must be deterministic and never leave the screen in an in-between offset state.

**Required behavior:**

1. Do not animate/persist panel offset during drag; detect swipe-up from gesture end translation only.
2. Disable swipe-down interactive dismissal for split/add-expense sheets; closing should be explicit (top controls).
3. Add setting `confirmPromptOnSwipeUpAddExpense` (default ON): ON shows confirmation prompt before swipe-up save; OFF saves directly on swipe-up.
4. When the swipe-confirm overlay is visible, a second upward swipe crossing threshold must execute the same save path as tapping `Save`, then fully reset panel offset/gesture state.

### Expense Save + Convex Acknowledgement Rule

Expense creation must not silently succeed locally while failing cloud sync in the same flow.

**Required behavior:**

1. Add-expense screen save path must use Convex-backed save (`addExpenseAndSync`) and surface backend/auth/config failures immediately.
2. If Convex upsert fails during creation, rollback the optimistic local insert for that new expense and keep the user on the creation screen with an actionable error.
3. Save-confirm and duplicate-warning prompts must share one alert state machine; avoid multiple `.alert` modifiers on the same root view to prevent prompt conflicts/no-op taps.
