rules_version = '2';
service cloud.firestore {
  function isSignedIn() {
    return request.auth != null && request.auth.token.email != null;
  }

  function userEmail() {
    return request.auth.token.email.lower();
  }

  function userUid() {
    return request.auth.uid;
  }

  match /databases/{database}/documents {
    match /users/{emailDocId} {
      allow create: if (isSignedIn() && userEmail() == emailDocId)
        || (!isSignedIn() && request.resource.data.email == emailDocId);

      allow read: if (isSignedIn() && userEmail() == emailDocId) || !isSignedIn();

      allow update, delete: if
        (isSignedIn() && userEmail() == emailDocId)
        || (!isSignedIn() && (
            (request.resource != null && request.resource.data.email == emailDocId)
            || (resource.data != null && resource.data.email == emailDocId)
        ));

      match /friends/{friendId} {
        allow read, write: if
          (isSignedIn() && userEmail() == emailDocId)
          || (!isSignedIn());
      }
    }

    match /expenses/{expenseId} {
      allow read, write: if true;
    }

    match /groups/{groupId} {
      allow read, write: if true;
    }

    // Link Requests Collection
    // Manages account linking requests between users
    match /linkRequests/{requestId} {
      allow read, write: if true;
    }

    // Invite Tokens Collection
    // Manages shareable invite links for account linking
    match /inviteTokens/{tokenId} {
      allow read, write: if true;
    }

    // Friends Collection (under users subcollection)
    // Updated to support linked accounts and nicknames
    match /friends/{friendDocId} {
      // Allow users to read and write their own friends
      // Friends are stored per user and include linking metadata
      allow read, write: if isSignedIn()
        && friendDocId == userEmail();
    }
  }
}
